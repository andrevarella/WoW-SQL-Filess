local NPC_ID = 94151

local function OnGossipHello(event, player, creature)
	player:SaveToDB()
    player:GossipMenuAddItem(3, "Salvar Talents - Primary Spec", 1, 1) -- Save Talents Primary Spec
    player:GossipMenuAddItem(3, "Salvar Talents - Secondary Spec", 1, 2) -- Save Talents Secondary Spec
	player:GossipMenuAddItem(3, "Aplicar Talents - Primary Spec", 1, 3, false, "Para aplicar os talents, será necessário relogar, tem certeza?")   -- Apply Primary Talents
	player:GossipMenuAddItem(3, "Aplicar Talents - Secondary Spec", 1, 4, false, "Para aplicar os talents, será necessário relogar, tem certeza?") -- Apply Secondary Talents (needs a relog to Update the talents for the player)
	
    player:GossipMenuAddItem(3, "Test", 1, 5) -- Test
	
    player:GossipMenuAddItem(3, "Resetar Talentos", 1, 499, false, "Tem certeza que quer Resetar os Talentos?") -- Reset Talents
    player:GossipSendMenu(1, creature)
end

local function OnGossipSelect(event, player, creature, sender, intid, code)
    player:GossipComplete()

    if intid == 1 or intid == 2 then -- Save current Primary/Secondary Talents
        local guid = player:GetGUIDLow()
        CharDBExecute("DELETE FROM custom_saved_talents WHERE guid = "..guid.." AND talentSlot = "..intid)
		player:SaveToDB()
        local result
        if intid == 1 then
			player:SaveToDB()
            result = CharDBQuery("SELECT spell, specMask FROM character_talent WHERE guid = "..guid.." AND (specMask = 1 OR specMask = 3)")
        elseif intid == 2 then
		player:SaveToDB()
            result = CharDBQuery("SELECT spell, specMask FROM character_talent WHERE guid = "..guid.." AND (specMask = 2 OR specMask = 3)")
		player:SaveToDB()
        end
		
        if result then
            repeat
                local spell = result:GetUInt32(0)
                local talentSlot = intid
                CharDBExecute("INSERT INTO custom_saved_talents (guid, spell, talentSlot) VALUES ("..guid..", "..spell..", "..talentSlot..")")
            until not result:NextRow()
        end
	

	elseif intid == 3 then -- Apply Stored Talents - Slot 1
		player:SaveToDB()
		
		local level = player:GetLevel()
		local requiredTalentPoints = level - 9

		if level >= 10 and player:GetFreeTalentPoints() < requiredTalentPoints then -- Needs to Not have talents unspent
			player:SendBroadcastMessage("Você precisa resetar os talentos para usar essa opção.")
			player:GossipComplete()
			return
		else
			local guid = player:GetGUIDLow()

			local result = CharDBQuery("SELECT spell FROM custom_saved_talents WHERE guid = "..guid.." AND talentSlot = 1")
			if result then
				repeat
					local spell = result:GetUInt32(0)
					local existingResult = CharDBQuery("SELECT specMask FROM character_talent WHERE guid = "..guid.." AND spell = "..spell)
					if existingResult then
						local specMask = existingResult:GetUInt32(0)
						if specMask == 2 then
							CharDBExecute("UPDATE character_talent SET specMask = 3 WHERE guid = "..guid.." AND spell = "..spell)
						end
					else
						CharDBExecute("INSERT INTO character_talent (guid, spell, specMask) VALUES ("..guid..", "..spell..", 1)")
					end
				until not result:NextRow()
			end
			player:LogoutPlayer(true)
		end
	end
	
	
	if intid == 5 then
		player:LearnTalent(player, 796, 16934)
	end
	

	if intid == 499 then
		player:ResetTalents()
		player:SaveToDB()
		player:SendBroadcastMessage("Seus Talentos foram resetados.") -- Reset Talents
		player:GossipComplete()
    end
	if(intid == 500) then -- Voltar (Back)
		OnGossipHello(event, player, creature)
	end
end


RegisterCreatureGossipEvent(NPC_ID, 1, OnGossipHello)
RegisterCreatureGossipEvent(NPC_ID, 2, OnGossipSelect)



	--[[
	elseif intid == 3 then
		player:SaveToDB()
		if player:GetFreeTalentPoints() > 0 then
            player:SendBroadcastMessage("Você não pode usar o teleporte enquanto estiver em combate.")
			player:GossipComplete()
            return
		else
			local guid = player:GetGUIDLow()
    
			-- Atualize as spells existentes de specMask 2 para 3 apenas se estiverem na lista custom_saved_talents com talentSlot 1
			CharDBExecute("UPDATE character_talent SET specMask = 3 WHERE guid = "..guid.." AND specMask = 2 AND spell IN (SELECT spell FROM custom_saved_talents WHERE guid = "..guid.." AND talentSlot = 1)")

			local result = CharDBQuery("SELECT spell FROM custom_saved_talents WHERE guid = "..guid.." AND talentSlot = 1")
			if result then
				repeat
					local spell = result:GetUInt32(0)
					local specMask = 1
					CharDBExecute("INSERT INTO character_talent (guid, spell, specMask) VALUES ("..guid..", "..spell..", "..specMask..")")
				until not result:NextRow()
			end
			player:LogoutPlayer(true)
		end
	end--]]