local NPC_ID = 94151

local function OnGossipHello(event, player, object)
	player:SaveToDB()
    player:GossipMenuAddItem(3, "Salvar Talents - Primary Spec", 1, 1)
    player:GossipMenuAddItem(3, "Salvar Talents - Secondary Spec", 1, 2)
	player:GossipMenuAddItem(3, "Aplicar Talents - Primary Spec", 1, 3, false, "Para aplicar os talents, ser치 necess치rio relogar, tem certeza?")
	player:GossipMenuAddItem(3, "Aplicar Talents - Secondary Spec", 1, 4, false, "Para aplicar os talents, ser치 necess치rio relogar, tem certeza?")
    player:GossipMenuAddItem(3, "Resetar Talentos", 1, 10, false, "Tem certeza que quer Resetar os Talentos?")
    player:GossipSendMenu(1, object)
end

local function OnGossipSelect(event, player, object, sender, intid, code)
    player:GossipComplete()
    local guid = player:GetGUIDLow()

    if intid == 1 or intid == 2 then -- Antes de inserir, remova todos os talentos correspondentes ao talentSlot selecionado
        CharDBExecute("DELETE FROM custom_saved_talents WHERE guid = "..guid.." AND talentSlot = "..intid)

		player:SaveToDB()
        local result
        if intid == 1 then
			player:SaveToDB()
            result = CharDBQuery("SELECT spell, specMask FROM character_talent WHERE guid = "..guid.." AND (specMask = 1 OR specMask = 3)")
        elseif intid == 2 then
		player:SaveToDB()
            result = CharDBQuery("SELECT spell, specMask FROM character_talent WHERE guid = "..guid.." AND (specMask = 2 OR specMask = 3)")
        end
		

        if result then
            repeat
                local spell = result:GetUInt32(0)
                local talentSlot = intid
                CharDBExecute("INSERT INTO custom_saved_talents (guid, spell, talentSlot) VALUES ("..guid..", "..spell..", "..talentSlot..")")
            until not result:NextRow()
        end
		
    elseif intid == 3 then
		player:SaveToDB()
        player:ResetTalents()
		player:SaveToDB()
		player:LogoutPlayer( true)

        local result = CharDBQuery("SELECT spell FROM custom_saved_talents WHERE talentSlot = 1")
        if result then
            repeat
                local spell = result:GetUInt32(0)
                local specMask = 1
                CharDBExecute("INSERT INTO character_talent (guid, spell, specMask) VALUES ("..guid..", "..spell..", "..specMask..")")
            until not result:NextRow()
        end
		
	elseif intid == 10 then
		player:ResetTalents()
		player:SendBroadcastMessage("Seus Talentos foram resetados.")
		OnGossipHello(event, player, object)
		
    end
end


RegisterCreatureGossipEvent(NPC_ID, 1, OnGossipHello)
RegisterCreatureGossipEvent(NPC_ID, 2, OnGossipSelect)