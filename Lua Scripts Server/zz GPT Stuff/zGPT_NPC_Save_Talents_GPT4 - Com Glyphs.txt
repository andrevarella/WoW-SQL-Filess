local NPC_ID = 94151

local function OnGossipHello(event, player, creature)
	player:SaveToDB()
    player:GossipMenuAddItem(3, "Salvar Talents - Primary Spec", 1, 1)
    player:GossipMenuAddItem(3, "Salvar Talents - Secondary Spec", 1, 2)
	player:GossipMenuAddItem(3, "Aplicar Talents - Primary Spec", 1, 3, false, "Para aplicar os talents, ser치 necess치rio relogar, tem certeza?")
	player:GossipMenuAddItem(3, "Aplicar Talents - Secondary Spec", 1, 4, false, "Para aplicar os talents, ser치 necess치rio relogar, tem certeza?")
	
    player:GossipMenuAddItem(3, "Testt", 0, 40)
	player:GossipMenuAddItem(3, "Glyphs", 0, 100)
    player:GossipMenuAddItem(3, "Resetar Talentos", 1, 499, false, "Tem certeza que quer Resetar os Talentos?")
    player:GossipSendMenu(1, creature)
end

local function OnGossipSelect(event, player, creature, sender, intid, code)
    player:GossipComplete()
    local guid = player:GetGUIDLow()

    if intid == 1 or intid == 2 then -- Antes de inserir, remova todos os talentos correspondentes ao talentSlot selecionado
        CharDBExecute("DELETE FROM custom_saved_talents WHERE guid = "..guid.." AND talentSlot = "..intid)

		player:SaveToDB()
        local result
        if intid == 1 then
			player:SaveToDB()
            result = CharDBQuery("SELECT spell, specMask FROM character_talent WHERE guid = "..guid.." AND (specMask = 1 OR specMask = 3)")
        elseif intid == 2 then
		player:SaveToDB()
            result = CharDBQuery("SELECT spell, specMask FROM character_talent WHERE guid = "..guid.." AND (specMask = 2 OR specMask = 3)")
        end
		

        if result then
            repeat
                local spell = result:GetUInt32(0)
                local talentSlot = intid
                CharDBExecute("INSERT INTO custom_saved_talents (guid, spell, talentSlot) VALUES ("..guid..", "..spell..", "..talentSlot..")")
            until not result:NextRow()
        end
	end
		
	--[[
    elseif intid == 3 then
		player:SaveToDB()
        player:ResetTalents()
		player:SaveToDB()
		player:LogoutPlayer( true)

        local result = CharDBQuery("SELECT spell FROM custom_saved_talents WHERE talentSlot = 1")
        if result then
            repeat
                local spell = result:GetUInt32(0)
                local specMask = 1
                CharDBExecute("INSERT INTO character_talent (guid, spell, specMask) VALUES ("..guid..", "..spell..", "..specMask..")")
            until not result:NextRow()
        end
	--]]
	
	
	
	

	--[[ addTalent - n funciona
	if intid == 40 then
		--bool Player::addTalent(uint32 spellId, uint8 addSpecMask, uint8 oldTalentRank)
		--addTalent(L, player, 1234, 0)
		--addTalent(player, 16938, 1, true)
		addTalent(player, 16938, 1, 0)
		player:GossipComplete()
	end--]]
	
	
	-- Major Glyphs
	if(intid == 100) then
		player:GossipSetText(string.format(" "))
		player:GossipMenuAddItem(6,"Glyph Major 1",0, 101)
		player:GossipMenuAddItem(6,"Glyph Major 2",0, 102)
		player:GossipMenuAddItem(6,"Glyph Major 3",0, 103)
		player:GossipMenuAddItem(6,"Glyph Minor 1",0, 104)
		player:GossipMenuAddItem(6,"Glyph Minor 2",0, 105)
		player:GossipMenuAddItem(6,"Glyph Minor 3",0, 106)
		player:GossipMenuAddItem(3,"|TInterface/PaperDollInfoFrame/UI-GearManager-Undo:27:27:0:0|t |cFF800000Voltar",0,499)
		player:GossipMenuAddItem(4,"|TInterface\\RaidFrame\\ReadyCheck-NotReady:22:22:0:0|t |cFF8B0000Sair",0,500)
		player:GossipSendMenu(0x7FFFFFFF, creature, menu_id)	
	end
	
	local MajorLeft  = 5
	local MajorRight = 3
	local MajorUp    = 0

	local MinorLeft  = 2
	local MinorRight = 4
	local MinorDown  = 1
	
	-- exemplos:
	if intid == 103 then 
		player:SetGlyph(190, MajorLeft)  -- Glyph of Righteous Defense
	end
	
	if intid == 104 then 
		player:SetGlyph(190, MajorRight)
	end
	


	
	if intid == 499 then
		player:ResetTalents()
		player:SendBroadcastMessage("Seus Talentos foram resetados.")
		OnGossipHello(event, player, creature)
    end
	if(intid == 500) then -- Voltar
		OnGossipHello(event, player, creature)
	end
	

end


RegisterCreatureGossipEvent(NPC_ID, 1, OnGossipHello)
RegisterCreatureGossipEvent(NPC_ID, 2, OnGossipSelect)