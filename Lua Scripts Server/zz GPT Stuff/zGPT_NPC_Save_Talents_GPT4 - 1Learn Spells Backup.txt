local NPC_ID = 94151

local function OnGossipHello(event, player, object)
	player:SaveToDB()
    player:GossipMenuAddItem(0, "Salvar Talents Primary Spec", 1, 1)
    player:GossipMenuAddItem(0, "Salvar Talents Secondary Spec", 1, 2)
	player:GossipMenuAddItem(0, "Aplicar Talents Primary Spec", 1, 3)
	player:GossipMenuAddItem(0, "Aplicar Talents Secondary Spec", 1, 4)
    player:GossipSendMenu(1, object)
end

local function LearnSpells(player, talentSlot)
    local guid = player:GetGUIDLow()
    local result = CharDBQuery("SELECT spell FROM custom_saved_talents WHERE guid = "..guid.." AND talentSlot = "..talentSlot)

    if result then
        repeat
            local spell = result:GetUInt32(0)
            player:LearnSpell(spell)
        until not result:NextRow()
    end
end

--[[
local function OnGossipSelect(event, player, object, sender, intid, code)
    player:GossipComplete()
    local guid = player:GetGUIDLow()

    if intid == 1 or intid == 2 then
        -- Antes de inserir, remova todos os talentos correspondentes ao talentSlot selecionado
        CharDBExecute("DELETE FROM custom_saved_talents WHERE guid = "..guid.." AND talentSlot = "..intid)

        local result
        if intid == 1 then
            result = CharDBQuery("SELECT spell, specMask FROM character_talent WHERE guid = "..guid.." AND (specMask = 1 OR specMask = 3)")
        elseif intid == 2 then
            result = CharDBQuery("SELECT spell, specMask FROM character_talent WHERE guid = "..guid.." AND (specMask = 2 OR specMask = 3)")
        end
		
		if intid == 3 then
			LearnSpells(player, 1) -- Aprender feitiços para talentSlot 1
		elseif intid == 4 then
			LearnSpells(player, 2) -- Aprender feitiços para talentSlot 2
		end

        if result then
            repeat
                local spell = result:GetUInt32(0)
                local specMask = result:GetUInt32(1)
                local talentSlot = intid

                CharDBExecute("INSERT INTO custom_saved_talents (guid, spell, specMask, talentSlot) VALUES ("..guid..", "..spell..", "..specMask..", "..talentSlot..")")
            until not result:NextRow()
        end
		
    end
end--]]
local function OnGossipSelect(event, player, object, sender, intid, code)
    player:GossipComplete()
    local guid = player:GetGUIDLow()

    if intid == 1 or intid == 2 then
        -- Antes de inserir, remova todos os talentos correspondentes ao talentSlot selecionado
        CharDBExecute("DELETE FROM custom_saved_talents WHERE guid = "..guid.." AND talentSlot = "..intid)

        local result
        if intid == 1 then
            result = CharDBQuery("SELECT spell, specMask FROM character_talent WHERE guid = "..guid.." AND (specMask = 1 OR specMask = 3)")
        elseif intid == 2 then
            result = CharDBQuery("SELECT spell, specMask FROM character_talent WHERE guid = "..guid.." AND (specMask = 2 OR specMask = 3)")
        end

        if result then
            repeat
                local spell = result:GetUInt32(0)
                local specMask = result:GetUInt32(1)
                local talentSlot = intid

                CharDBExecute("INSERT INTO custom_saved_talents (guid, spell, specMask, talentSlot) VALUES ("..guid..", "..spell..", "..specMask..", "..talentSlot..")")
            until not result:NextRow()
        end

    elseif intid == 3 then
        LearnSpells(player, 1) -- Aprender feitiços para talentSlot 1
    elseif intid == 4 then
        LearnSpells(player, 2) -- Aprender feitiços para talentSlot 2
    end
end


RegisterCreatureGossipEvent(NPC_ID, 1, OnGossipHello)
RegisterCreatureGossipEvent(NPC_ID, 2, OnGossipSelect)